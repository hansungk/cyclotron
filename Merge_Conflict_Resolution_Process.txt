Cyclotron Merge Conflict Resolution Process
Date: 2026-02-07

Goal
- Merge main into the performance-model branch while preserving main's functional behavior/API changes.
- Keep performance-model timing-layer behavior as a separate layer on top of functional execution.

Resolution Principles Applied
1. Main-side functional behavior was treated as source of truth.
2. Main-side public/signature-level API changes were preserved.
3. Timing-layer logic was reintroduced where it does not override functional correctness.
4. Compatibility helpers were added only where needed (for existing timing tests/utilities).

Per-File Conflict Handling

1) src/cluster.rs
- Preserved main constructor signature: Cluster::new(config, id, logger, gmem).
- Added Cluster::new_with_timing(...) for explicit timing graph injection.
- Core construction now uses MuonCore::new_with_timing(...) so timing state is configured without changing main's functional entrypoint.
- all_cores_retired() now waits for both functional retirement and no timing inflight activity.

2) src/dpi/backend_model.rs
- Accepted deletion from main.
- Reason: backend DPI behavior is handled in src/dpi/mod.rs in main; keeping the deleted file would duplicate/fragment interfaces.

3) src/dpi/mod.rs
- Kept main version for initialization, make_sim usage, and DPI interface behavior.
- Preserved main's make_sim(None, &args) flow and single source for DPI backend logic.

4) src/main.rs
- Kept main startup path and make_sim API usage:
  make_sim(Some(&toml_string), &Some(argv)).

5) src/muon/config.rs
- Kept main defaults and shape (including num_regs=256 and start_pc=0x10000000).
- Removed performance-branch-only smem_base_addr from the config struct to align with main's shared-memory direction.

6) src/muon/core.rs
- Preserved main constructor signature: MuonCore::new(config, cluster_id, core_id, logger, gmem).
- Added MuonCore::new_with_timing(...) for explicit timing setup.
- Reintroduced timing model integration in frontend/backend:
  - fetch gating via allow_fetch
  - per-cycle timing tick
  - issue mask selection and scheduler stats
  - replay/wait handling on timing backpressure
- Kept functional execute/process interfaces from main.

7) src/muon/execute.rs
- Kept main implementation.
- This preserves main's shared/global memory opcode-extension behavior and current functional execute semantics.

8) src/muon/scheduler.rs
- Kept main SFU functional behavior (including BAR handling and WSPAWN semantics).
- Reintroduced timing backpressure support fields/methods:
  - resource_wait_until
  - neutrino_stalled_mask
  - set_resource_wait_until / clear_resource_wait / replay_instruction
  - active_warp_mask / stalled_warp_mask
- schedule() now honors timing/neutrino stalls while preserving main scheduling contract.
- Added get_schedule() shim calling schedule() for timing tests expecting legacy name.

9) src/muon/warp.rs
- Kept main functional backend API:
  backend(...) -> Result<Writeback, ExecErr>
- Added timing-path backend API:
  backend_timed(...) -> Result<Option<Writeback>, ExecErr>
- Timing backend issues requests/events to timing graph for:
  - GMEM/SMEM
  - execute pipeline
  - cache flushes
  - barrier and CSR timing notifications
- Kept main execute() call shape and set_block_threads_bp API.

10) src/sim/top.rs
- Preserved main Sim::new(...) signature and functional top flow.
- Added Sim::new_with_timing(...) to pass timing configs explicitly.
- ClusterConfig now carries timing_config (for timing-layer graph construction).
- CyclotronTop constructs shared cluster-level GMEM timing graph and uses Cluster::new_with_timing(...).
- Kept main tohost handling; reintroduced performance summary emission at completion/timeout.

11) src/ui.rs
- Preserved main make_sim signature:
  make_sim(toml_string: Option<&str>, cli_args: &Option<CyclotronArgs>)
- Reintroduced timing config include/merge logic from performance branch.
- make_sim now calls Sim::new_with_timing(...) while preserving main CLI override behavior.

Build/Test Validation
- Command: cargo check
  Result: PASS
- Command: cargo test
  Result: PASS (181 passed, 0 failed)

Outcome
- Merge conflicts were resolved with main as functional source of truth.
- Timing-layer behavior remains integrated as an additive layer.
- Project compiles and full cargo test suite passes.
